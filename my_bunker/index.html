<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ –ë—É–Ω–∫–µ—Ä</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; color: white; font-family: Arial; }
        
        .header { 
            height: 30vh; 
            background: #222; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            text-align: center; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 30px 20px; 
        }
        
        .card { 
            background: #1a1a1a; 
            border-radius: 10px; 
            padding: 25px; 
            margin: 20px 0; 
            border: 1px solid #333; 
        }
        .card h2 { 
            color: #4CAF50; 
            margin-bottom: 20px; 
        }
        
        .btn { 
            background: #4CAF50; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 6px; 
            font-size: 16px; 
            cursor: pointer; 
            margin: 5px;
        }
        
        input { 
            width: 100%; 
            padding: 12px; 
            background: #2a2a2a; 
            border: 1px solid #444; 
            border-radius: 6px; 
            color: white; 
            margin: 10px 0; 
        }
        
        .players { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
            gap: 10px; 
            margin: 20px 0; 
        }
        .player { 
            background: #2a2a2a; 
            padding: 15px; 
            border-radius: 8px; 
        }
        
        .error { 
            color: #ff6b6b; 
            background: #5d0000; 
            padding: 10px; 
            border-radius: 5px; 
            margin: 10px 0; 
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        const ROLES = ["–ü–æ–≤–∞—Ä", "–ü–æ–ª–∏—Ü–µ–π—Å–∫–∏–π", "–£—á–µ–Ω—ã–π", "–ë–∏–æ–ª–æ–≥", "–§–∏–∑–∏–∫", "–°–ø–æ—Ä—Ç—Å–º–µ–Ω"];
        
        class Game {
            constructor() {
                this.room = null;
                this.me = '';
                this.init();
            }
            
            init() {
                const urlParams = new URLSearchParams(window.location.search);
                const roomData = urlParams.get('r');
                
                if (roomData) {
                    try {
                        this.room = JSON.parse(decodeURIComponent(roomData));
                        const player = urlParams.get('p');
                        if (player && this.room.players.includes(decodeURIComponent(player))) {
                            this.me = decodeURIComponent(player);
                            this.showRoom();
                        } else {
                            this.showJoin();
                        }
                    } catch (e) {
                        this.showMain();
                    }
                } else {
                    this.showMain();
                }
            }
            
            showMain() {
                document.getElementById('app').innerHTML = `
                    <div class="header">
                        <h1>üéÆ –ë—É–Ω–∫–µ—Ä</h1>
                    </div>
                    <div class="container">
                        <div class="card">
                            <h2>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</h2>
                            <input id="roomName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã" value="–ò–≥—Ä–∞">
                            <input id="myName" placeholder="–¢–≤–æ–µ –∏–º—è">
                            <button class="btn" onclick="game.createRoom()">–°–æ–∑–¥–∞—Ç—å</button>
                        </div>
                    </div>
                `;
            }
            
            showJoin() {
                if (!this.room) return this.showMain();
                
                document.getElementById('app').innerHTML = `
                    <div class="header">
                        <h1>üéÆ –í—Ö–æ–¥ –≤ –∏–≥—Ä—É</h1>
                        <p>${this.room.name}</p>
                    </div>
                    <div class="container">
                        <div class="card">
                            <h2>–í–≤–µ–¥–∏—Ç–µ –∏–º—è</h2>
                            <input id="joinName" placeholder="–¢–≤–æ–µ –∏–º—è">
                            <button class="btn" onclick="game.join()">–í–æ–π—Ç–∏</button>
                        </div>
                    </div>
                `;
            }
            
            showRoom() {
                if (!this.room || !this.me) return this.showMain();
                
                const isCreator = this.me === this.creator;
                const role = this.room.roles ? this.room.roles[this.me] : null;
                const link = window.location.origin + window.location.pathname + '?r=' + encodeURIComponent(JSON.stringify(this.room)) + '&p=' + encodeURIComponent(this.me);
                
                document.getElementById('app').innerHTML = `
                    <div class="header">
                        <h1>üéÆ ${this.room.name}</h1>
                        <p>–í—ã: ${this.me} ${isCreator ? 'üëë' : ''}</p>
                    </div>
                    <div class="container">
                        <div class="card">
                            <h2>–°—Å—ã–ª–∫–∞</h2>
                            <p>${link.substring(0, 80)}...</p>
                            <button class="btn" onclick="navigator.clipboard.writeText('${link}').then(() => alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!'))">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="btn" onclick="location.reload()">–û–±–Ω–æ–≤–∏—Ç—å</button>
                        </div>
                        
                        ${isCreator && this.room.players.length >= 2 && !this.room.gameStarted ? `
                            <div class="card">
                                <button class="btn" onclick="game.start()" style="background:gold;color:black;">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É (${this.room.players.length})</button>
                            </div>
                        ` : ''}
                        
                        ${role ? `
                            <div class="card">
                                <h2>–¢–≤–æ—è —Ä–æ–ª—å: ${role}</h2>
                            </div>
                        ` : ''}
                        
                        <div class="card">
                            <h2>–ò–≥—Ä–æ–∫–∏ (${this.room.players.length}/6)</h2>
                            <div class="players">
                                ${this.room.players.map(p => `
                                    <div class="player">
                                        ${p} ${p === this.me ? '(–í—ã)' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            createRoom() {
                const roomName = document.getElementById('roomName').value || '–ò–≥—Ä–∞';
                const myName = document.getElementById('myName').value.trim();
                
                if (!myName) {
                    alert('–í–≤–µ–¥–∏ –∏–º—è!');
                    return;
                }
                
                this.room = {
                    name: roomName,
                    creator: myName,
                    players: [myName],
                    roles: {},
                    gameStarted: false
                };
                
                this.me = myName;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º URL
                const newUrl = window.location.origin + window.location.pathname + '?r=' + encodeURIComponent(JSON.stringify(this.room)) + '&p=' + encodeURIComponent(this.me);
                window.history.replaceState({}, '', newUrl);
                
                this.showRoom();
                alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ URL! –°–∫–∏–Ω—å –¥—Ä—É–≥—É.');
            }
            
            join() {
                const joinName = document.getElementById('joinName').value.trim();
                
                if (!joinName) {
                    alert('–í–≤–µ–¥–∏ –∏–º—è!');
                    return;
                }
                
                if (!this.room) {
                    alert('–û—à–∏–±–∫–∞ –∫–æ–º–Ω–∞—Ç—ã');
                    return;
                }
                
                if (this.room.players.includes(joinName)) {
                    alert('–ò–º—è –∑–∞–Ω—è—Ç–æ!');
                    return;
                }
                
                this.room.players.push(joinName);
                this.me = joinName;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º URL
                const newUrl = window.location.origin + window.location.pathname + '?r=' + encodeURIComponent(JSON.stringify(this.room)) + '&p=' + encodeURIComponent(this.me);
                window.history.replaceState({}, '', newUrl);
                
                this.showRoom();
            }
            
            start() {
                if (!this.room || this.me !== this.room.creator) return;
                
                if (this.room.players.length < 2) {
                    alert('–ù—É–∂–Ω–æ 2+ –∏–≥—Ä–æ–∫–∞!');
                    return;
                }
                
                // –†–∞–∑–¥–∞–µ–º —Ä–æ–ª–∏
                const shuffled = [...ROLES].sort(() => Math.random() - 0.5);
                this.room.roles = {};
                this.room.players.forEach((player, i) => {
                    if (i < shuffled.length) {
                        this.room.roles[player] = shuffled[i];
                    }
                });
                
                this.room.gameStarted = true;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º URL
                const newUrl = window.location.origin + window.location.pathname + '?r=' + encodeURIComponent(JSON.stringify(this.room)) + '&p=' + encodeURIComponent(this.me);
                window.history.replaceState({}, '', newUrl);
                
                this.showRoom();
                alert('–ò–≥—Ä–∞ –Ω–∞—á–∞—Ç–∞!');
            }
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è
        window.game = new Game();
    </script>
</body>
</html>