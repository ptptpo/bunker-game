<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ –ë—É–Ω–∫–µ—Ä</title>
    <style>
        body { background: #000; color: white; font-family: Arial; margin: 0; padding: 20px; }
        .room { max-width: 600px; margin: 0 auto; background: #1a1a1a; padding: 20px; border-radius: 10px; }
        h1 { color: #4CAF50; text-align: center; }
        .players { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin: 20px 0; }
        .player { background: #2a2a2a; padding: 10px; border-radius: 5px; }
        .player.creator { border-left: 4px solid #ff9800; }
        button { background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        input { width: 100%; padding: 10px; margin: 10px 0; background: #333; color: white; border: 1px solid #444; border-radius: 5px; }
        .link { background: #222; padding: 10px; border-radius: 5px; margin: 10px 0; word-break: break-all; font-size: 12px; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // –†–æ–ª–∏ –±–µ–∑ —ç–º–æ–¥–∑–∏ –¥–ª—è –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
        const ROLES = ["–ü–æ–≤–∞—Ä", "–ü–æ–ª–∏—Ü–µ–π—Å–∫–∏–π", "–£—á–µ–Ω—ã–π", "–ë–∏–æ–ª–æ–≥", "–§–∏–∑–∏–∫", "–°–ø–æ—Ä—Ç—Å–º–µ–Ω"];
        // –≠–º–æ–¥–∑–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const ROLE_EMOJIS = ["üë®‚Äçüç≥", "üëÆ", "üë®‚Äçüî¨", "üë®‚Äçüî¨", "üë®‚Äçüî¨", "üèÉ"];
        
        let currentRoom = null;
        let myName = '';
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function init() {
            const url = new URL(window.location.href);
            const roomData = url.searchParams.get('r');
            
            if (roomData) {
                try {
                    currentRoom = JSON.parse(atob(roomData));
                    showRoom();
                } catch {
                    showJoinForm();
                }
            } else {
                showMainPage();
            }
        }
        
        // –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
        function showMainPage() {
            document.getElementById('app').innerHTML = `
                <div class="room">
                    <h1>üéÆ –ë—É–Ω–∫–µ—Ä</h1>
                    <input id="roomName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã" value="–ú–æ—è –∏–≥—Ä–∞">
                    <input id="creatorName" placeholder="–í–∞—à–µ –∏–º—è">
                    <button onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
                </div>
            `;
        }
        
        // –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞
        function showJoinForm() {
            if (!currentRoom) {
                showMainPage();
                return;
            }
            
            document.getElementById('app').innerHTML = `
                <div class="room">
                    <h1>–í–æ–π—Ç–∏ –≤ –∏–≥—Ä—É</h1>
                    <p>–ö–æ–º–Ω–∞—Ç–∞: ${currentRoom.name || '?'}</p>
                    <input id="playerName" placeholder="–í–∞—à–µ –∏–º—è">
                    <button onclick="joinRoom()">–í–æ–π—Ç–∏</button>
                </div>
            `;
        }
        
        // –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–æ–º–Ω–∞—Ç—ã
        function showRoom() {
            if (!currentRoom || !myName) {
                showMainPage();
                return;
            }
            
            const isCreator = myName === currentRoom.creator;
            const myRoleIndex = currentRoom.roles ? currentRoom.roles[myName] : -1;
            const myRole = myRoleIndex >= 0 ? ROLE_EMOJIS[myRoleIndex] + ' ' + ROLES[myRoleIndex] : '';
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É
            const roomLink = `${window.location.origin}${window.location.pathname}?r=${btoa(JSON.stringify(currentRoom))}`;
            
            document.getElementById('app').innerHTML = `
                <div class="room">
                    <h1>${currentRoom.name || '–ò–≥—Ä–∞'}</h1>
                    <p>–í—ã: ${myName} ${isCreator ? 'üëë' : ''}</p>
                    
                    <div class="link">${roomLink.substring(0, 60)}...</div>
                    <button onclick="copyLink('${roomLink}')">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
                    <button onclick="location.reload()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                    
                    ${isCreator && !currentRoom.gameStarted && currentRoom.players.length >= 2 ? 
                        `<button onclick="startGame()">üéÆ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É (${currentRoom.players.length} –∏–≥—Ä–æ–∫–∞)</button>` : ''}
                    
                    ${myRole ? `<h2 style="color: #ffd700;">–í–∞—à–∞ —Ä–æ–ª—å: ${myRole}</h2>` : ''}
                    
                    <h3>–ò–≥—Ä–æ–∫–∏ (${currentRoom.players.length}/6):</h3>
                    <div class="players">
                        ${currentRoom.players.map(player => {
                            const roleIndex = currentRoom.roles ? currentRoom.roles[player] : -1;
                            const role = roleIndex >= 0 ? ROLE_EMOJIS[roleIndex] + ' ' + ROLES[roleIndex] : '';
                            const isMe = player === myName;
                            
                            return `
                                <div class="player ${player === currentRoom.creator ? 'creator' : ''}">
                                    ${player} ${isMe ? '(–í—ã)' : ''}
                                    ${currentRoom.gameStarted && role && (isMe || isCreator) ? 
                                        `<br><small style="color: #4CAF50">${role}</small>` : 
                                        currentRoom.gameStarted ? '<br><small style="color: #666">–†–æ–ª—å —Å–∫—Ä—ã—Ç–∞</small>' : ''
                                    }
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            setTimeout(() => {
                if (currentRoom && myName) location.reload();
            }, 3000);
        }
        
        // –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
        function createRoom() {
            const roomName = document.getElementById('roomName').value || '–ò–≥—Ä–∞';
            const creatorName = document.getElementById('creatorName').value.trim();
            
            if (!creatorName) {
                alert('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è!');
                return;
            }
            
            currentRoom = {
                id: Date.now().toString(),
                name: roomName,
                creator: creatorName,
                players: [creatorName],
                roles: {},
                gameStarted: false
            };
            
            myName = creatorName;
            updateURL();
        }
        
        // –í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É
        function joinRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            
            if (!playerName) {
                alert('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è!');
                return;
            }
            
            if (!currentRoom) {
                alert('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
                return;
            }
            
            if (currentRoom.players.includes(playerName)) {
                alert('–≠—Ç–æ –∏–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ!');
                return;
            }
            
            if (currentRoom.players.length >= 6) {
                alert('–ö–æ–º–Ω–∞—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞! –ú–∞–∫—Å–∏–º—É–º 6 –∏–≥—Ä–æ–∫–æ–≤.');
                return;
            }
            
            currentRoom.players.push(playerName);
            myName = playerName;
            updateURL();
        }
        
        // –ù–∞—á–∞—Ç—å –∏–≥—Ä—É
        function startGame() {
            if (!currentRoom || myName !== currentRoom.creator) return;
            
            if (currentRoom.players.length < 2) {
                alert('–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –∏–≥—Ä–æ–∫–∞!');
                return;
            }
            
            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã —Ä–æ–ª–µ–π
            const roleIndices = Array.from({length: Math.min(currentRoom.players.length, ROLES.length)}, (_, i) => i);
            roleIndices.sort(() => Math.random() - 0.5);
            
            // –ù–∞–∑–Ω–∞—á–∞–µ–º —Ä–æ–ª–∏
            currentRoom.roles = {};
            currentRoom.players.forEach((player, i) => {
                if (i < roleIndices.length) {
                    currentRoom.roles[player] = roleIndices[i];
                }
            });
            
            currentRoom.gameStarted = true;
            updateURL();
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å URL
        function updateURL() {
            if (!currentRoom) return;
            
            const newURL = `${window.location.origin}${window.location.pathname}?r=${btoa(JSON.stringify(currentRoom))}`;
            window.history.replaceState({}, '', newURL);
            showRoom();
        }
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
        function copyLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–∑—å—è–º.');
            });
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        window.createRoom = createRoom;
        window.joinRoom = joinRoom;
        window.startGame = startGame;
        window.copyLink = copyLink;
        
        // –ó–∞–ø—É—Å–∫
        window.onload = init;
    </script>
</body>
</html>